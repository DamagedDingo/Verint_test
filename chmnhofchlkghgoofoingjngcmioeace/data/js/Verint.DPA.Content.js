"use strict";var r={SetTraceLevel:"SetTraceLevel",GetControls:"GetControls",GotControls:"GotControls",Busy:"Busy",TriggerUpdate:"TriggerUpdate",Event:"Event",Element:"Element",RemoveControls:"RemoveControls",EnableSessionDebug:"EnableSessionDebug",DisableSessionDebug:"DisableSessionDebug"},e={Element:1,Attribute:2,Text:3,Comment:8},o={CTRL_NONE:0,CTRL_EDIT:1,CTRL_LIST:2,CTRL_COMBO:3,CTRL_BUTTON:4,CTRL_CHECK:5,CTRL_HTML:6,CTRL_TEXT:7,CTRL_RADIO:8,CTRL_SELECT:9,CTRL_TXTAREA:10,CTRL_OBJECT:11,CTRL_SERVEROBJ:12,CTRL_BTNOTHER:13,CTRL_MENU:14,CTRL_ANCHOR:15,CTRL_HLLAPI:16,CTRL_IMG:17,CTRL_HOTKEY:18,CTRL_HOTSPOT:19,CTRL_JAVANONE:20,CTRL_JAVABUTTON:21,CTRL_JAVATEXT:22,CTRL_JAVACOMBOBOX:23,CTRL_JAVACHECKBOX:24,CTRL_JAVALABEL:25,CTRL_JAVALIST:26,CTRL_JAVAPAGETAB:27,CTRL_JAVARADIOBUTTON:28,CTRL_JAVAINTERNALFRAME:29,CTRL_JAVAEND:30,CTRL_JAVAPLACEHOLDER1:31,CTRL_JAVAPLACEHOLDER2:32,CTRL_JAVAPLACEHOLDER3:33,CTRL_JAVAPLACEHOLDER4:34,CTRL_JAVAPLACEHOLDER5:35,CTRL_JAVAPLACEHOLDER6:36,CTRL_JAVAPLACEHOLDER7:37,CTRL_JAVAPLACEHOLDER8:38,CTRL_JAVAPLACEHOLDER9:39,CTRL_JAVAPLACEHOLDER10:40,CTRL_EBUTTON:41,CTRL_TABLE:42,CTRL_WQSFIELD:43,CTRL_COSFIELD:44,CTRL_PCMFIELD:45,CTRL_LISTVIEW:46,CTRL_LISTVIEWCOLUMN:47,CTRL_TAB:48,CTRL_HEADER:49,CTRL_WFHYPERLINK:50,CTRL_ATMFIELD:51,CTRL_PASSFIELD:52,CTRL_RUMBWHFIELD:53,CTRL_LOCATION:54,CTRL_BUTTONPASSBACK:55,CTRL_IMGBUTTON:56,CTRL_RICHEDIT:57,CTRL_TABLEROW:58,CTRL_ACCESSWEB:59,CTRL_ACCESSWEBWIN:60,CTRL_FRAMESET:61,CTRL_TRIGVAR:62,CTRL_TRIGVARCLEAR:63,CTRL_TABLECOLUMN:64},d=null;function m(){var e=new Date;return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)}function c(e,t){if(d&&t<=3||t<=C){t="";try{for(var o="["+m()+"]\t",n=arguments.length,r=Array(2<n?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];var i=r.map(function(e){return"object"==typeof e||"array"==typeof e?JSON.stringify(e):e}),t=o+"- ["+A+"] -["+e+"]"+(R&&-1!==b?" [tabId: "+R+", frameId: "+b+"]":"")+"\t "+i.join(" ");console.log(t),He({Msg:"Log",User:p,Value:t})}catch(e){console.error("Could not perform full DPA logging:",t),console.error(e)}}}var n,g,C=0,T=null,I=/.*[\\\/](.*)$/,L=["SCRIPT","FORM","FRAMESET","NOSCRIPT","HTM","HEAD","HR","META","MAP","STYLE","BR","NOBR","BODY","AREA","FONT","OPTION","FRAME","IFRAME"],h=["DIV","SPAN","TABLE","TR","TD"],E=["id","style","class"],f=[],p="unkown",v=new MutationObserver(x),y={},P={},S=500,s="DpaBhoId",R=-1,b=-1,D={childList:!0,characterData:!0,subtree:!0,attributes:!0,attributeFilter:["src","checked","value","innerText","selectedIndex","text","textContent"].concat(E)},A="Verint.DPA.Client.Plugin",N={},i=(window.dpa=window.dpa||{},{neverVisible:"neverVisible",visible:"visible",noLongerVisible:"noLongerVisible"}),B="visibilityState";function M(){g&&clearTimeout(g),g=setTimeout(O,750)}function O(){c("getControlList",1,"Entered"),a({Msg:r.GetControls})}function _(){c("connect",3,"Connecting to BG Script"),(n=chrome.runtime.connect({name:"verintcsclient"})).onMessage.addListener(k),n.onDisconnect.addListener(V),O()}function V(e){_()}function a(e){n&&n.postMessage(e)}function k(e){e.Msg==r.SetTraceLevel?(R=e.tabId,b=e.frameId,C=e.TraceLevel,(d=e.enableSessionDebug)?window.dpa.addStyles():window.dpa.removeStyles(),c("onMessage",5,"Set trace level to ",e.TraceLevel)):e.Msg===r.Busy?c("onMessage",1,"MsgType.Busy"):e.Msg===r.GotControls?(c("onMessage",1,"Got controls:",e.Controls),fe(),f=e.Controls,p=e.User,w(),Ne()):e.Msg===r.TriggerUpdate&&(c("onMessage",1,"Got trigger update - fetching updated controls"),O())}function w(){N={},f.forEach(function(e){N[e.Tag]=document.getElementsByTagName(e.Tag)})}function F(e){c("DocumentEvent",1,"Got ",e.type," event on document. Resending values"),ke(document).forEach(function(t){u(t).forEach(function(e){a({Msg:r.Event,Type:"change",BhoId:e,Tag:t.tagName,Id:t.id,Value:Ie(t)})})})}function H(e){c("ProcessDom",3,"Document -> addDocEventListeners Started"),e.addEventListener("change",F,!1),c("ProcessDom",3,"Document -> addDocEventListeners Completed")}function x(e){J(U,e,S)}function J(e,t,o){var n,r=P[e.name];r?G(y[r],t):(n=e,r=setTimeout(function(){var e=P[n.name],e=(c("Debounce",3,"Completed debounce function:",n.name,", timeoutId:",e,". Total debounced data size:",y[e].length),y[e]);P[n.name]=null,delete y[r],n(e)},o),P[e.name]=r,y[r]=t,c("Debounce",3,"Starting new debounce period on timeoutId",r))}function G(e,t){e.push.apply(e,t)}function U(e){c("Mutation",3,"HandleMutations total debounced:",e.length);var t=[],o=[],n=(e.forEach(function(e){"attributes"===e.type?o.push(e.target):"characterData"===e.type?o.push(e.target.parentNode):"childList"===e.type&&(o.push(e.target),e=Fe(e.removedNodes),G(t,e))}),c("Mutation",3,"HandleMutations removedNodes:",t.length),c("Mutation",3,"HandleMutations changedNodes:",o.length),te(t),[]);o.forEach(function(e){G(n,ke(e))}),c("Mutation",3,"HandleMutations hookedElements with changes:",n.length),n.forEach(z),n.forEach(Z),Ne()}function u(e){var t=[];return e&&e.attributes&&0<e.attributes.length&&((e=e.attributes.getNamedItem(s))&&0<e.value.length&&(t=e.value.split(",").map(Number))),t}function W(e,t){var o="";t.length&&(o=t.map(String).join(",")),e.setAttribute(s,o)}function X(e,t){var o=u(e),t=o.indexOf(t);0<=t&&o.splice(t,1),W(e,o)}function q(e,t){var o=u(e);o.push(t),W(e,o)}function z(t){c("Mutation",3,">>> reEvaluateHookedControl"),u(t).forEach(function(e){return K(e,t)}),c("Mutation",3,"<<< reEvaluateHookedControl")}function K(e,t){var o,n,r=$(e);r?(xe(r),(o=ve(r,N[r.Tag]))?(c("Mutation",3,"Control still hooks to an element. Deterimine action..."),void 0===(n=u(o))||0===n.length?(c("Mutation",3,"Control now hooks an unhooked element. Rehooking..."),ge(t,e),Ce(o,r)):-1===n.indexOf(e)?(c("Mutation",3,"Found a control but it is already hooked to another control. Adding new bho Id to this element"),ge(t,e),Ce(o,r)):0<=n.indexOf(e)&&(c("Mutation",3,"Same control found. If value has changed then this is handled by another process."),Me(o)===i.noLongerVisible&&(c("Mutation",3,"Control no longer hooks to an element. Control was visible but is no longer."),Q(t,r)))):(c("Mutation",3,"Control no longer hooks to an element. Control Not Found."),Q(t,r))):c("Mutation",3,"<<< Could not find control for BhoId",e,", Error: Should always find elements and controls at this point in process.")}function Q(e,t){oe([t.BhoInd]),ge(e,t.BhoInd),j(t)}function Y(e){var n=[];e.forEach(function(o){u(o).forEach(function(e){var t=$(e);n.push(e),j(t),ge(o,e)})}),oe(n)}function j(e){e.Found=!1,e.CurrentValue=void 0,e.Element=void 0}function $(c){var e=!0,t=!1,o=void 0;try{for(var n,r=f[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var l=n.value,s=!0,i=!1,a=void 0;try{for(var u,d=l.ControlList[Symbol.iterator]();!(s=(u=d.next()).done);s=!0){var m=u.value;if(m.BhoInd===c)return m}}catch(e){i=!0,a=e}finally{try{!s&&d.return&&d.return()}finally{if(i)throw a}}}}catch(e){t=!0,o=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw o}}}function Z(n){c("Mutation",5,">>> resendValue");var e=u(n);e.length?(e.forEach(function(e){var t=$(e),o=(xe(t,5),Ie(n));t.CurrentValue!==o&&(Te(n,o,e),ee(e,o,n))}),c("Mutation",5,"<<< resendValue")):c("Mutation",5,"<<< resendValue not a hooked control")}function ee(e,t,o){e=$(Number(e));e.CurrentValue=t,e.Element=o}function te(e){var t=[];e.forEach(function(e){e=ke(e);G(t,e)}),t.length&&Y(t)}function oe(e){c("Mutation",3,"sendEventRemoveControls:",e),a({Msg:r.RemoveControls,BhoIds:e})}function ne(e,t){if(e.SmId){if(c("ProcessDom",5,"GetControlByShortmatchId() - Tag:",e.Tag,", SmId:",e.SmId,", SrcInd:",e.SrcInd,", node.id:",t.id),t.id.match(e.SmId)){if(c("ProcessDom",5,"IdPos:",e.IdPos,", CurSmIdPos:",e.CurSmIdPos),e.IdPos===e.CurSmIdPos-1&&!e.Found)return e.Id=t.id,!0;e.CurSmIdPos++}return!1}return c("ProcessDom",5,"GetControlByShortmatchId() - No SmId on control"),!1}function re(e,t,o){c("ProcessDom",5,"GetControlByText() - Tag:",e.Tag,", Text:",e.Text,", SrcInd:",e.SrcInd,", Tag Value:",o);var n=!1;return e.Text.trim()===o.trim()&&(c("ProcessDom",5,"Check on ImgPos: ",e.ImgPos,", CurImgPos: ",e.CurImgPos),e.ImgPos!==e.CurImgPos||e.Found||(n=!0),e.CurImgPos++),n}function se(e){var t=e.match(I);return t?t[t.length-1]:e}function ie(e,t,o){c("ProcessDom",5,"GetControlByFileName() - Tag:",e.Tag,", Text:",e.Text,", SrcInd:",e.SrcInd);o=se(o);if(c("ProcessDom",5,"Filename:",o),o===e.Text){if(c("ProcessDom",5,"ImgPos:",e.ImgPos,", CurImgPos:",e.CurImgPos),e.ImgPos===e.CurImgPos&&!e.Found)return c("ProcessDom",5," <<  GetControlByFileName() - Found Control"),!0;e.CurImgPos++}return c("ProcessDom",5,"  << GetControlByFileName() - false"),!1}function ae(e,t,o){if((c("ProcessDom",5,"GetControlByImgButton() Tag:",e.Tag,", ID:",e.Id,", SrcInd:",e.SrcInd,", CurIDPos:",e.CurIdPos,"value:",o),"image"===t.type)&&se(o)===e.Id){if(e.IdPos===e.CurIdPos)return!0;e.CurIdPos++}return!1}function ue(e,t){return c("ProcessDom",5,"GetControlByValue() - Tag:",e.Tag,", Value:",e.Value,", SrcInd:",e.SrcInd,", value:",t),e.Value.trim()===t.trim()}function de(e){return e.byInputImage||e.byShortMatch||e.byText||e.byValue||e.byFileName}function t(t){var o=t.currentTarget,n=Ie(o);u(o).forEach(function(e){ee(e,n,o),c("ProcessDom",3,"Got event type: ",t.type,", BhoId: ",e,", Tag: ",o.tagName,", Id: ",o.id,", Value: ",n),a({Msg:r.Event,Type:t.type,BhoId:e,Tag:o.tagName,Id:o.id,Value:n})})}function ce(e){c("ProcessDom",5,"NODE -> addNodeEventListeners Started"),e.addEventListener("click",t,!1),e.addEventListener("submit",t,!1),e.addEventListener("reset",t,!1),c("ProcessDom",5,"NODE <- addNodeEventListeners Completed")}function le(e){c("ProcessDom",5,"NODE -> addNodeKeyEventListeners Started"),e.addEventListener("keydown",t,!1),e.addEventListener("keyup",t,!1),e.addEventListener("change",t,!1),e.addEventListener("paste",t,!1),c("ProcessDom",5,"NODE <- addNodeKeyEventListeners Completed")}function me(e){c("ProcessDom",5,"NODE -> removeNodeEventListeners Started"),e.removeEventListener("click",t,!1),e.removeEventListener("keydown",t,!1),e.removeEventListener("keyup",t,!1),e.removeEventListener("submit",t,!1),e.removeEventListener("reset",t,!1),e.removeEventListener("change",t,!1),e.removeEventListener("paste",t,!1),c("ProcessDom",5,"NODE <- removeNodeEventListeners Completed")}function fe(){ke(document).forEach(function(t){u(t).forEach(function(e){ge(t,e)})})}function ge(e,t){e&&(X(e,t),u(e).length||(me(e),e.attributes.removeNamedItem(s)))}function Ce(e,t){var o,n=e.tagName.toUpperCase();L.findIndex(function(e){return e===n})<0?(e.hasAttribute(s)&&c("ProcessDom",3,"Already Hooked - Supporting multiple BHO IDs."),o=Ie(e),ee(t.BhoInd,o,e),t.Found=!0,q(e,t.BhoInd),Te(e,o,t.BhoInd),ce(e),h.findIndex(function(e){return e===n})<0&&le(e)):c("ProcessDom",3,"Won't Hook - Ignore Tag")}function Te(e,t,o){o&&(c("ProcessDom",3,"Sending Element BhoId: ",o,", Tag: ",e.tagName,", Id: ",e.id,", Value: ",t),a({Msg:r.Element,BhoId:o,Tag:e.tagName,Id:e.id,Value:t}))}function Ie(e){switch(e.tagName){case"IMG":return se(e.src);case"INPUT":return Le(e);case"SELECT":return he(e);case"TEXTAREA":return e.value;case"BUTTON":return e.value||e.innerText;default:return(e.textContent||e.innerText||"").replace(/(\r\n|\n|\r|\t)/gm," ").replace(/ +(?= )/g,"")}}function Le(e){switch(c("ProcessDom",5,"Element type: ",e.type),e.type){case"radio":case"checkbox":return e.checked?"Checked":"Unchecked";case"image":return se(e.src);case"password":return"*********";case"hidden":return e.value||e.innerText;default:return e.value}}function he(e){e=e.options.item(e.selectedIndex);return e?e.text:""}function Ee(e){c("ProcessDom",3,">>> processTag ",e.Tag);var t="";d&&(t=JSON.stringify({tag:e.Tag}),performance.mark(t),l(t,"Processing Tag")),l(t,"Starting Control List"),e.ControlList.filter(function(e){return!e.Found}).forEach(function(e){return pe(e)}),l(t,"Tag Processed"),Re(),c("ProcessDom",3,"<<< processTag ",e.Tag)}function pe(t){try{xe(t,3);var e=ve(t);try{e?(c("ProcessDom",3,"Found Control By element List - Tag: ",t.Tag," Control: Id: ",t.Id,", Type: ",t.Type,", IdPos:",t.IdPos,", SrcInd:",t.SrcInd),Me(e)!==i.noLongerVisible?Ce(e,t):c("ProcessDom",3,"Found a previously hooked control that is no longer visible. Will not rehook.")):c("ProcessDom",3," Did not find Control with Id: ",t.Id)}catch(e){c("ProcessDom",1,"findElementAndHook - Caught Assignment Error: ",e)}}catch(e){c("ProcessDom",1,"ERROR: findElementAndHook had unexpected. Control",{dpaControl:t,err:e})}}function ve(e){c("ProcessDom",3,"Searching for control {",e.BhoInd,"}"),xe(e,3);var t=N[e.Tag],o=void 0,n=Se(e);return e.opts.byQuerySelector?(c("ProcessDom",3,"find by byQuerySelector efficient - ",e.opts.byQuerySelector),o=ye(e)):e.opts.byTagIndex&&t.length>e.SrcInd&&(c("ProcessDom",3,"find by TagIndex efficient"),o=t[e.SrcInd]),!o&&e.opts.byXPath&&(c("ProcessDom",3,"find by byXPath efficient - ",e.opts.byXPath),o=document.evaluate(e.opts.byXPath,document.body,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE).snapshotItem(0)),c("ProcessDom",3,"Efficient searches compelete: Found ",!!o),l(n,"non-iterating search complete foundControl: ",0!=o),l(n,"Iterating searches Complete foundControl: ",0!=(o=!o&&de(e.opts)?Pe(t,e):o)),l(n,"Control Processed"),o}function ye(e){var t=void 0,o=e.IdPos-e.opts.indexStart;return 0==o?document.querySelector(e.opts.byQuerySelector):(e=document.querySelectorAll(e.opts.byQuerySelector)).length>o?e[o]:t}function Pe(e,t){c("ProcessDom",3,"element loop needed to find control. List Length:",e.length);var o=void 0;t.CurBtnIdPos&&(t.CurBtnIdPos=1),t.CurSmIdPos&&(t.CurSmIdPos=1),t.CurIdPos&&(t.CurIdPos=1),t.CurImgPos&&(t.CurImgPos=1);for(var n=0;!o&&n<e.length;n++){var r=e[n],s=Ie(r),i=r.type;if(t.opts.byInputImage&&"image"===i){if(be(t))break;ae(t,r,s)&&(o=r)}else if(t.opts.byFileName){if(De(t))break;ie(t,r,s)&&(o=r)}else t.opts.byText?re(t,r,s)&&(o=r):t.opts.byValue&&ue(t,s)&&(o=r);if(!o&&t.opts.byShortMatch){if(Ae(t))break;ne(t,r)&&(o=r)}}return o}function Se(e){var t="";if(d){var o=[],n=!0,r=!1,s=void 0;try{for(var i,a=Object.keys(e.opts)[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var u=i.value;e.opts[u]&&o.push(u)}}catch(e){r=!0,s=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw s}}t=JSON.stringify({by:o,tag:e.Tag,type:e.Type,id:e.Id,SrcInd:e.SrcInd,BhoInd:e.BhoInd,IdPos:e.IdPos,ImgPos:e.ImgPos}),performance.mark(t)}return t}function l(e,t){d&&performance.measure(t+"-"+e,e)}function Re(){d&&(performance.getEntriesByType("measure").forEach(function(e){c("ProcessTag Performance:",2,"{time: "+e.duration+", measure: "+e.name+"}")}),performance.clearMarks(),performance.clearMeasures())}function be(e){return 0===e.IdPos&&1<e.CurIdPos?(c("ProcessDom",3,"Breaking element Loop control zero control not found in zero position"),!0):e.CurIdPos-1>e.IdPos&&(c("ProcessDom",3,"Breaking element Loop control id looked for is already passed in looping quit"),!0)}function De(e){return 0===e.ImgPos&&1<e.CurImgPos?(c("ProcessDom",3,"Breaking element Loop control zero control not found in zero position"),!0):e.CurImgPos-1>e.ImgPos&&(c("ProcessDom",3,"Breaking element Loop control id looked for is already passed in looping quit"),!0)}function Ae(e){return 0===e.IdPos&&1<e.CurSmIdPos?(c("ProcessDom",3,"Breaking element Loop control zero control not found in zero position"),!0):e.CurSmIdPos-1>e.IdPos&&(c("ProcessDom",3,"Breaking element Loop control id looked for is already passed in looping quit"),!0)}function Ne(){c("findControls",3,"Stopping mutation observer"),v.disconnect(),f.length?(f.forEach(Ee),window.dpa.logControlStatus(),c("findControls",3,"Starting mutation observer"),v.observe(document,D)):c("findControls",3,"No controls, ignoring mutations")}function Be(e){var t=0<e.offsetWidth&&0<e.offsetHeight;return t=t?"hidden"!==(e=Ve(e)).visibility&&"none"!==e.display:t}function Me(e){c("Controls",3,">>> progressVisibilityState");var t=Oe(e),o=Be(e),n=null;return(n=t?t===i.neverVisible&&o?i.visible:t!==i.visible||o?t===i.noLongerVisible&&o?i.visible:t:i.noLongerVisible:o?i.visible:i.neverVisible)!==t&&(c("Controls",3,"progressVisibilityState Change"),_e(e,n)),c("Controls",3,"<<< progressVisibilityState",{currentState:t,isVisible:o,newState:n}),n}function Oe(e){return e.getAttributeNS("dpa",B)}function _e(e,t){return e.setAttributeNS("dpa",B,t)}function Ve(e){return window.getComputedStyle?window.getComputedStyle(e,null):e.currentStyle}function ke(e){for(var t=[],o=(e.querySelectorAll&&(t=Fe(e.querySelectorAll("["+s+"]"))),e.parentNode);o;)we(o)&&t.push(o),o=o.parentNode;return we(e)&&t.push(e),t}function we(e){return!!(e&&e.attributes&&0<e.attributes.length)&&!!e.attributes.getNamedItem(s)}function Fe(e){for(var t=[],o=0,n=t.length=e.length;o<n;o++)t[o]=e[o];return t}function He(e){a(e)}function xe(e,t){if(d||0<t){var o=[],n=!0,r=!1,s=void 0;try{for(var i,a=Object.keys(e.opts)[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var u=i.value;e.opts[u]&&o.push(u+": "+e.opts[u])}}catch(e){r=!0,s=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw s}}c("Controls",t,{BhoInd:e.BhoInd,Id:e.Id,Found:e.Found,CurrentValue:e.CurrentValue,QueryOptions:o})}}function Je(){return document.head||document.getElementsByTagName("head")[0]}chrome.runtime.onMessage.addListener(k),_(),H(document),window.dpa.logControlStatus=function(){(d||0<C)&&(c("Controls",3,">>> Control Status"),window.dpa.listControls().forEach(function(e){return xe(e,3)}),c("Controls",3,"<<< Control Status"))},window.dpa.listControls=function(){return f?f.map(function(e){return e.ControlList}).flat():(c("Controls",3,"No Controls"),[])},window.dpa.enableSessionDebug=function(){a({Msg:r.EnableSessionDebug})},window.dpa.disableSessionDebug=function(){a({Msg:r.DisableSessionDebug})},window.dpa.addStyles=function(){var e="["+s+"] { \n\t\t\tbackground-color: #FDFF47;\n\t\t\tborder: 1px dotted red;\n\t\t}",t=document.createElement("style");t.id=s,t.appendChild(document.createTextNode(e)),Je().appendChild(t)},window.dpa.removeStyles=function(){Fe(document.head.getElementsByTagName("style")).forEach(function(e){e.id===s&&document.head.removeChild(e)})};