"use strict";var o={SetTraceLevel:"SetTraceLevel",GetControls:"GetControls",GotControls:"GotControls",Busy:"Busy",TriggerUpdate:"TriggerUpdate",Event:"Event",Element:"Element",RemoveControls:"RemoveControls",EnableSessionDebug:"EnableSessionDebug",DisableSessionDebug:"DisableSessionDebug"},e={Element:1,Attribute:2,Text:3,Comment:8},r={CTRL_NONE:0,CTRL_EDIT:1,CTRL_LIST:2,CTRL_COMBO:3,CTRL_BUTTON:4,CTRL_CHECK:5,CTRL_HTML:6,CTRL_TEXT:7,CTRL_RADIO:8,CTRL_SELECT:9,CTRL_TXTAREA:10,CTRL_OBJECT:11,CTRL_SERVEROBJ:12,CTRL_BTNOTHER:13,CTRL_MENU:14,CTRL_ANCHOR:15,CTRL_HLLAPI:16,CTRL_IMG:17,CTRL_HOTKEY:18,CTRL_HOTSPOT:19,CTRL_JAVANONE:20,CTRL_JAVABUTTON:21,CTRL_JAVATEXT:22,CTRL_JAVACOMBOBOX:23,CTRL_JAVACHECKBOX:24,CTRL_JAVALABEL:25,CTRL_JAVALIST:26,CTRL_JAVAPAGETAB:27,CTRL_JAVARADIOBUTTON:28,CTRL_JAVAINTERNALFRAME:29,CTRL_JAVAEND:30,CTRL_JAVAPLACEHOLDER1:31,CTRL_JAVAPLACEHOLDER2:32,CTRL_JAVAPLACEHOLDER3:33,CTRL_JAVAPLACEHOLDER4:34,CTRL_JAVAPLACEHOLDER5:35,CTRL_JAVAPLACEHOLDER6:36,CTRL_JAVAPLACEHOLDER7:37,CTRL_JAVAPLACEHOLDER8:38,CTRL_JAVAPLACEHOLDER9:39,CTRL_JAVAPLACEHOLDER10:40,CTRL_EBUTTON:41,CTRL_TABLE:42,CTRL_WQSFIELD:43,CTRL_COSFIELD:44,CTRL_PCMFIELD:45,CTRL_LISTVIEW:46,CTRL_LISTVIEWCOLUMN:47,CTRL_TAB:48,CTRL_HEADER:49,CTRL_WFHYPERLINK:50,CTRL_ATMFIELD:51,CTRL_PASSFIELD:52,CTRL_RUMBWHFIELD:53,CTRL_LOCATION:54,CTRL_BUTTONPASSBACK:55,CTRL_IMGBUTTON:56,CTRL_RICHEDIT:57,CTRL_TABLEROW:58,CTRL_ACCESSWEB:59,CTRL_ACCESSWEBWIN:60,CTRL_FRAMESET:61,CTRL_TRIGVAR:62,CTRL_TRIGVARCLEAR:63,CTRL_TABLECOLUMN:64},i=null;function C(){var e=new Date;return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)}function s(e,t){if(i&&t<=3||t<=g){t="";try{for(var n="["+C()+"]\t",o=arguments.length,r=Array(2<o?o-2:0),a=2;a<o;a++)r[a-2]=arguments[a];var s=r.map(function(e){return"object"==typeof e||"array"==typeof e?JSON.stringify(e):e}),t=n+"- ["+S+"] -["+e+"]"+(A&&-1!==v?" [tabId: "+A+", frameId: "+v+"]":"")+"\t "+s.join(" ");console.log(t),ae({Msg:"Log",User:b,Value:t})}catch(e){console.error("Could not perform full DPA logging:",t),console.error(e)}}}var a,L,c=window.chrome||window.browser||{},t=(c.tabs.onActivated.addListener(l),c.tabs.onRemoved.addListener(W),c.tabs.onUpdated.addListener(H),c.runtime.onConnect.addListener(X),c.windows.onFocusChanged.addListener(l),c.webNavigation.onCompleted.addListener(K),-1),d=[],n=!1,g=0,f=!0,b="None",R=0,m=0,T=-1,p=/\(.*?\)/g,I=/#.*$/g,S="Verint.DPA.Client.Background",E=100,A=null,v=null;function y(){"WebSocket"in window?(s("startWebSocket",1,"Browser supports web sockets"),n=!0,_()):(s("startWebSocket",1,"Browser does not support web sockets!"),n=!1)}function _(){if(n&&!a){s("connectWS",1,"Connect to WS");try{a=new WebSocket("ws://127.0.0.1:1510/browserservice/")}catch(e){s("connectWS",1,"connectWS() ERROR: ",e)}a.onopen=function(){s("connectWS",1,"Web socket connected!"),l(null),G()},a.onclose=O,a.onerror=function(e){s("connectWS",1,"Web socket error:",e)},a.onmessage=D}}function O(){s("socketIsDisconnected",1,"Web socket closed!"),a=null,setTimeout(_,1e3)}function h(n,o){s("setTraceLevel",5,"SetTraceLevel:",o),g=o;var e=c.runtime.getManifest();s("setTraceLevel",3,"manifestData.name:",e.name),s("setTraceLevel",3,"manifestData.version",e.version),s("setTraceLevel",3,"browser:",navigator.userAgent),M(n).then(function(e){e.forEach(function(e){var t={Msg:"SetTraceLevel",TraceLevel:o,tabId:n,frameId:e.frameId,enableSessionDebug:i};x(n,t,{frameId:e.frameId})})})}function M(n){return new Promise(function(t,e){c.webNavigation.getAllFrames({tabId:n},function(e){e&&t(e.filter(function(e){return e&&!1===e.errorOccurred}))})})}function w(t){h(t.TabId,t.TraceLevel),R=t.SessId,b=t.User,m=t.TrigVer,d.filter(function(e){return e.tabId==t.TabId&&"Tab"===e.type}).forEach(function(e){s("updateControlList",1,"Sending trigger update notification to all frames (",t.TabId,")"),e.controls=t.UrlList,x(t.TabId,{Msg:o.TriggerUpdate})})}function D(t){try{var e,n;t.data.includes("ConnectionKey")?(e=t.data.split("="),L=e[1]):(s("wsMessage",1,"Got browser service message:",n=JSON.parse(t.data)),"ProcessDom"===n.Msg?w(n):"SetTraceLevel"===n.Msg?(s("wsMessage",5,"SetTraceLevel: TraceLevel: ",n.TraceLevel,", TabId: ",n.TabId),h(n.TabId,n.TraceLevel)):"TriggerUpdate"===n.Msg&&(w(n.ControlList),G()))}catch(e){s("wsMessage",1,"onmessage() ERROR: ",e),s("wsMessage",1,t.data)}}y();var N=20,P=250;function U(n){(function e(t){a&&a.readyState===WebSocket.OPEN?n():0<t&&setTimeout(function(){e(t-1)},P)})(N)}function B(e){var t,n;return CryptoJS&&L?(t=CryptoJS.enc.Utf8.parse(L),n=CryptoJS.enc.Utf8.parse("8080808080808080"),CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(e),t,{keySize:16,iv:n,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7})):e}function F(n){U(function(){try{n.Browser="Chrome";var e=JSON.stringify(n),t=B(e);a.send(t),f&&s("wsSend",1,"Sending Server Message: ",e)}catch(e){f&&s("wsSend",1,"wsSend() ERROR: ",e)}})}function V(t){U(function(){try{t.Browser="Chrome";var e=JSON.stringify(t);a.send(e)}catch(e){f&&s("wsSendLog",1,"wsSend() ERROR: ",e)}})}function l(t){s("onActivated",3,"onActivated"),c.tabs.query({active:!0,currentWindow:!0},function(e){if(!e)return s(1,"ReprocessControls No tabs. Try again. "),void setTimeout(function(){l(t)},E);1===e.length&&(e[0].id!=T&&0<=T&&F({Msg:"SetInactive",SessId:R,Ids:[T]}),F({Msg:"SetUrl",SessId:R,TabId:e[0].id,Url:u(e[0].url),Title:e[0].title}),T=e[0].id,s("onActivated",3,"Active tab: ",e[0].id))})}function J(t,n){c.tabs.get(t,function(e){e?(s("getTab",3,"<<< getTab",t,", found tab with URL: '",e.url),n(e)):s("getTab",3,"<<< getTab '",t,"' could not be found")})}function x(e,t,n){s("sendCsMessage",3,arguments);try{c.tabs.sendMessage(e,t,n)}catch(e){s("sendCsMessage",1,"error "+e)}}function G(){c.tabs.query({},function(e){if(!e)return s("ReprocessControls",1,"No tabs. Try again. "),void setTimeout(G,E);e.forEach(function(e){x(e.id,{Msg:o.TriggerUpdate})})})}function W(t,e){for(var n=0;n<d.length;n++)if(d[n].tabId===t){s("onTabRemoved",5,"Removing tab(",t,")");for(var o=!0;o;){var r=d.findIndex(function(e){return e.tabId===t});0<=r?d.splice(r,1):o=!1}}}function H(e,t){s("onUpdated",1,"onUpdated(",e,",",t,")"),t.url||t.title?k(e,t.url,t.title):s("onUpdated",1,"Change ignored.")}function k(e,t,n){s("sendUrlChange",1,"sendUrlChange(",e,",",t,",",n,")");var o=j(e),t=u(t);0<=o&&(o=d[o],t&&o.url!==t&&(o.url=t),o.title!==n&&null!=n&&(o.title=n),T===e&&l())}function K(e){var t,n;s("navigationCompleted",1,"Web navigation completed for tab(",e.tabId,"), frame(",e.frameId,"), new url = ",e.url),0===e.frameId&&(t=void 0,n=e,c.tabs.get(n.tabId,function(e){e&&(t=e.title),k(n.tabId,n.url,t)}))}function X(e){var t,n;"verintcsclient"===e.name&&e.sender&&e.sender.tab&&(s("onConnect",1,"New connection from tab(",e.sender.tab.id,"), frame(",e.sender.frameId,")"),e.sender.tab.id<0?s("onConnect",1,"Not a valid tab. Ignoring. This has been found with web workers."):(t={type:"Tab",tabId:e.sender.tab.id,url:u(e.sender.tab.url),title:e.sender.tab.title,frameId:e.sender.frameId,port:e},0===e.sender.frameId?(t.trigver=-1,t.controls=[]):(t.type="Frame",t.url=u(e.sender.url)),0<=(n=q(t.tabId,t.frameId))&&d.splice(n,1),d.push(t),e.onMessage.addListener(te),e.onDisconnect.addListener(Q)))}function Q(e){var t=q(e.sender.tab.id,e.sender.frameId);s("onDisconnect",1,"Got disconnect from tab(",e.sender.tab.id,"), frame(",e.sender.frameId,"), tabPos(",t,")"),0<=t&&d[t].url===u(e.sender.url)?d.splice(t,1):0<=t&&(s("onDisconnect",5,"Tab not removed:"),s("onDisconnect",5,"\tTabDetails url: ",d[t].url),s("onDisconnect",5,"\tSender url: ",e.sender.url),s("onDisconnect",5,"\tSender url(stripped): ",u(e.sender.url)))}function u(e){return e&&unescape(e.replace(p,""))}function j(t){var e=d.findIndex(function(e){return e.tabId===t&&"Tab"===e.type});return s("getTabPosition",5,"getTabPosition(",t,"):",e),e}function q(t,n){var e=d.findIndex(function(e){return e.tabId===t&&e.frameId===n});return s("getTabOrFramePosition",5,"getTabPosition(",t,",",n,"):",e),e}function Y(e,t){s("GetControls",5,"tabId:",e,", frameId:",t);var n,o,r=Promise.resolve([]),a=j(e);return 0<=a&&(n=d[a],0===t?(s("GetControls",5,"Looking for controls on document"),o=[],n.controls.forEach(function(e){e.TagList&&(o=o.concat(e.TagList))}),r=Promise.resolve(o)):(s("GetControls",5,"Looking for controls on frame"),n.controls&&(r=ne(e,t).then(function(e){return $(e,n.controls)}).catch(function(e){return s("GetControls",1,e)})))),r.then(z)}function z(e){return e.forEach(function(t){t.ControlList.forEach(function(e){e.opts=Z(e,t)})}),Promise.resolve(e)}function $(e,t){var n=[],o=u(e.toLowerCase());return s("GetControls",5,"Looking for controls on frame:",o,"against control list",t),t.forEach(function(e){e.FrameList&&e.FrameList.forEach(function(e){s("GetControls",5,"Compare on frame",e.FrameUrl.toLowerCase()),e.FrameRegEx&&s("GetControls",5,"Compare on frame regex",e.FrameRegEx),(o.includes(e.FrameUrl.toLowerCase())||e.FrameRegEx&&new RegExp(e.FrameRegEx).test(o))&&(n=n.concat(e.TagList))})}),Promise.resolve(n)}function Z(e,t){var n={byQuerySelector:!1,byInputImage:!1,byShortMatch:!1,byText:!1,byValue:!1,byTagIndex:!1,byFileName:!1,indexStart:0,byXPath:!1};return e.Id?(s("getSearchOptions",5,"Control has Tag:",t.Tag,", Type:",e.Type,", Idpos:",e.IdPos," ,Id ",e.Id),n.byQuerySelector=ee(e),"INPUT"===t.Tag&&e.Type===r.CTRL_IMGBUTTON&&(n.byInputImage=!0,n.indexStart=1),e.SmId&&(s("getSearchOptions",5,"Control has shortmatch on id"),n.byShortMatch=!0)):e.Text?(s("getSearchOptions",5,"Control has Text, Type:",e.Type,", Text",e.Text),e.Type===r.CTRL_IMG?(s("getSearchOptions",5,"Control find by filename"),n.byFileName=!0,n.indexStart=1):(s("getSearchOptions",5,"Control find by text"),n.byText=!0)):e.Type===r.CTRL_EBUTTON&&e.Value?(s("getSearchOptions",5,"Control is Type 41 EBUTTON with value to find"),n.byValue=!0):e.Selector||(s("getSearchOptions",5,"Control find by index"),n.byTagIndex=!0),e.Selector&&(n.byXPath=e.Selector),n}function ee(t){var e=[],n=(s("getQuerySelectorForControl",3,">>> getQuerySelectorForControl: ",t),"INPUT"===t.Tag?(n=function(e){return'input[id="'+t.Id+'"][type="'+e+'"]'},t.Type===r.CTRL_TEXT?(e=["text","hidden"].map(n)).push('input[id="'+t.Id+'"]:not([type])'):t.Type===r.CTRL_RADIO?e=["radio"].map(n):t.Type===r.CTRL_PASSFIELD?e=["password"].map(n):t.Type===r.CTRL_CHECK?e=["checkbox"].map(n):t.Type===r.CTRL_BUTTON||t.Type===r.CTRL_BUTTONPASSBACK?e=["button","submit","image"].map(n):t.Type!==r.CTRL_IMGBUTTON&&(n=["button","submit","image","checkbox","password","text","hidden","radio"].map(function(e){return':not([type="'+e+'"])'}),e=[n='input[id="'+t.Id+'"][type]'+n.join("")])):e=[t.Tag+'[id="'+t.Id+'"]'],e.join(","));return s("getQuerySelectorForControl",3,"<<< getQuerySelectorForControl: ",n),n}function te(e,t){"Log"!=e.Msg?(s("handleContentScriptMessage",3,"handleContentScriptMessage: {request: ",e,"}"),e.Msg===o.GetControls?re(t):e.Msg===o.Element||e.Msg===o.Event||e.Msg===o.RemoveControls?(e.User=b,e.TrigVer=m,e.TabId=t.sender.tab.id,s("handleContentScriptMessage",3,"Sending Control Event to service:",e),F(e)):e.Msg===o.EnableSessionDebug?(i=!0,h(t.sender.tab.id,g)):e.Msg===o.DisableSessionDebug?(i=!1,h(t.sender.tab.id,g)):s("handleContentScriptMessage",3,"Got other Msg:",e.Msg)):t.sender.tab.id&&!i&&V({Msg:"Log",User:b,TabId:t.sender.tab.id,SessId:R,Value:e.Value})}function ne(e,t){e=q(e,t);return 0<=e?Promise.resolve(d[e].url):Promise.reject("getFrameUrl found no tab details")}function oe(n,o){return new Promise(function(t,e){c.webNavigation.getFrame({tabId:n,frameId:o},function(e){e&&t(e)})})}function re(t){s("resolveControlsForTab",1,"GetControls tab(",t.sender.tab.id,"), frame(",t.sender.frameId,")");var n={Msg:o.Busy},e=j(t.sender.tab.id);0<=e?(n.Msg=o.GotControls,s("resolveControlsForTab",5,"Checking stored url ",d[e].url),Y(t.sender.tab.id,t.sender.frameId).then(function(e){n.Controls=e,s("resolveControlsForTab",1,"Sending msg:",n),t.postMessage(n)})):(s("resolveControlsForTab",5,"Tab not found -> sending empty list of controls"),n.MsgType=o.GotControls,n.Controls=[],t.postMessage(n))}function ae(e){e.TabId=t,V(e)}